---
title: "Diffusion spatio-temporelle des salles d'escalade de bloc en France"
description: ""
author: "JMF"
date: 2018-05-12T15:29:28+02:00
tags: ["R"]
coversize: full
output: 
  blogdown::html_page:
    toc: true
---


<div id="TOC">
<ul>
<li><a href="#constitution-de-la-base-de-donnees-des-salles-de-blocs-en-france">Constitution de la base de données des salles de blocs en France</a><ul>
<li><a href="#extraction-des-donnees-brutes-google-places">Extraction des données brutes (Google Places)</a></li>
</ul></li>
</ul>
</div>

<p>Pour mon premier post, j’ai choisi un thème qui me tient à coeur : <strong>l’escalade</strong>. Je pratique ce sport depuis 15 ans environ, et, depuis quelques années, une chose m’a frappé : on trouve de plus en plus de salles d’escalade de blocs, et cela partout en France. Pour le géographe que je suis, cela ne fait pas de toute, nous assistons là à une ce que l’on nomme une <strong>diffusion spatiale d’innovation</strong> dans un système urbain.</p>
<p>Pendant très longtemps, sur Paris, la seule salle d’escalade de blocs, c’était <a href="http://www.antrebloc.com/">Antrebloc</a> à Villejuif. Au nord, on avait <a href="https://www.murmur.fr/">MurMur</a> (mais qui ne faisait pas vraiment de bloc, juste un pan), et c’était tout ou presque en ce qui concerne les salles privées. Ce n’est pas que le bloc était une activité confidentielle, simplement, tout du moins en région parisienne, elle était pratiquée en milieu naturel (Fontainebleau).</p>
<div id="constitution-de-la-base-de-donnees-des-salles-de-blocs-en-france" class="section level1">
<h1>Constitution de la base de données des salles de blocs en France</h1>
<p>L’objectif est de consituer une base avec, pour chaque salle :</p>
<ul>
<li>le nom</li>
<li>l’adresse</li>
<li>la longitude/latitude</li>
<li>la date d’ouverture</li>
</ul>
<div id="extraction-des-donnees-brutes-google-places" class="section level2">
<h2>Extraction des données brutes (Google Places)</h2>
<p>Plusieurs méthodes sont possibles : scrapping des storelocators (<em>via</em> la package <code>rvest</code> par exemple) des enseignes, de sites spécialisés comme , mais le plus rapide et certainement le plus efficace est de faire appel à Google Places<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> que l’on va interroger <em>via</em> le package <a href="https://cran.r-project.org/web/packages/googleway/index.html"><code>googleway</code></a>.</p>
<pre class="r"><code>library(RPostgreSQL)
library(googleway)

# liste des communes de plus de 5000 hab
con &lt;- dbConnect(PostgreSQL(), user= &quot;postgres&quot;, password=&quot;postgres&quot;, dbname=&quot;am&quot;, host = &quot;localhost&quot;,  port=5432)

lst_ville &lt;- dbGetQuery(con,&quot;select insee_com, nom_com from geo.geofla_commune_2015 where population &gt; 5000;&quot;)

result &lt;- data.frame(place_id = NULL, nom = NULL, adresse = NULL,
                     rating = NULL, lat = NULL, lng = NULL, tags = NULL, ville = NULL,
                     stringsAsFactors = F)
compteur &lt;- 0
for (i in lst_ville$nom_com) {
  compteur &lt;- compteur + 1
  tryCatch({
    gp &lt;- google_places(key = APIkey,search_string = paste0(&quot;salle escalade bloc &quot;, i, &quot;, france&quot;),language = &quot;fr&quot;)
    temp &lt;- data.frame(place_id = gp$results$place_id,
                       nom = gp$results$name,
                       adresse = gp$results$formatted_address,
                       lat = gp$results$geometry$location$lat,
                       lng = gp$results$geometry$location$lng,
                       types = sapply(gp$results$types,paste0,collapse = &quot; &quot;),
                       ville = i,
                       stringsAsFactors = F)
    result &lt;- rbind(result, temp)
    }, error = function(e) {print(paste0(i,&quot; KO&quot;))})
  print(paste(compteur,&quot;:&quot;,i))
}

result_dedup &lt;- result[!duplicated(result$place_id),]</code></pre>
<p>On obtient 648 enregistrements.</p>
<pre class="r"><code>library(dplyr)
library(kableExtra)

result_dedup %&gt;% 
  sample_n(., size = 10, replace = TRUE) %&gt;%
  kable(caption = &#39;echantillon de 10 places&#39;) %&gt;%
  kable_styling(bootstrap_options = &quot;striped&quot;, font_size = 8)</code></pre>
<table class="table table-striped" style="font-size: 8px; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
<span id="tab:tableau1">Table 1: </span>echantillon de 10 places
</caption>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
place_id
</th>
<th style="text-align:left;">
nom
</th>
<th style="text-align:left;">
adresse
</th>
<th style="text-align:right;">
lat
</th>
<th style="text-align:right;">
lng
</th>
<th style="text-align:left;">
types
</th>
<th style="text-align:left;">
ville
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
829
</td>
<td style="text-align:left;">
ChIJ7cn6i_Do5UcRPU80Q9LGtng
</td>
<td style="text-align:left;">
Beauvais : Nainville
</td>
<td style="text-align:left;">
D75, 91750 Champcueil, France
</td>
<td style="text-align:right;">
48.50307
</td>
<td style="text-align:right;">
2.4792127
</td>
<td style="text-align:left;">
point_of_interest establishment
</td>
<td style="text-align:left;">
DAMMARIE-LES-LYS
</td>
</tr>
<tr>
<td style="text-align:left;">
2435
</td>
<td style="text-align:left;">
ChIJa_QWeoAZyRIRVRn0QrfdTzw
</td>
<td style="text-align:left;">
Club Alpin du COUDON
</td>
<td style="text-align:left;">
152 Rue Léon Guérin, 83160 La Valette-du-Var, France
</td>
<td style="text-align:right;">
43.13650
</td>
<td style="text-align:right;">
5.9838311
</td>
<td style="text-align:left;">
point_of_interest establishment
</td>
<td style="text-align:left;">
LA CRAU
</td>
</tr>
<tr>
<td style="text-align:left;">
15444
</td>
<td style="text-align:left;">
ChIJUy2YAwanrRIR38IZl7epjlg
</td>
<td style="text-align:left;">
CLUB VILPY: randonnée, escalade, canyoning
</td>
<td style="text-align:left;">
19 Rue Mailhes, 12200 Villefranche-de-Rouergue, France
</td>
<td style="text-align:right;">
44.35258
</td>
<td style="text-align:right;">
2.0317771
</td>
<td style="text-align:left;">
point_of_interest establishment
</td>
<td style="text-align:left;">
VILLEFRANCHE-DE-ROUERGUE
</td>
</tr>
<tr>
<td style="text-align:left;">
1900
</td>
<td style="text-align:left;">
ChIJURTtecMb90cR_EqwbPHnDx8
</td>
<td style="text-align:left;">
Groupe Alpiniste Gaulois
</td>
<td style="text-align:left;">
22Ter Impasse Bonnabaud, 63000 Clermont-Ferrand, France
</td>
<td style="text-align:right;">
45.77529
</td>
<td style="text-align:right;">
3.0787026
</td>
<td style="text-align:left;">
point_of_interest establishment
</td>
<td style="text-align:left;">
CEYRAT
</td>
</tr>
<tr>
<td style="text-align:left;">
12895
</td>
<td style="text-align:left;">
ChIJT812hfGZ_UcRjwiP4kgmxgg
</td>
<td style="text-align:left;">
Salle des fêtes
</td>
<td style="text-align:left;">
5 Rue Alphonse Plault, 86170 Neuville-de-Poitou, France
</td>
<td style="text-align:right;">
46.68458
</td>
<td style="text-align:right;">
0.2459579
</td>
<td style="text-align:left;">
point_of_interest establishment
</td>
<td style="text-align:left;">
NEUVILLE-DE-POITOU
</td>
</tr>
<tr>
<td style="text-align:left;">
10179
</td>
<td style="text-align:left;">
ChIJrR__ySniE0gRxo9LiSWhtcA
</td>
<td style="text-align:left;">
Salle Omnisports
</td>
<td style="text-align:left;">
46 Rue des Carmes, 29250 Saint-Pol-de-Léon, France
</td>
<td style="text-align:right;">
48.68258
</td>
<td style="text-align:right;">
-3.9940911
</td>
<td style="text-align:left;">
point_of_interest establishment
</td>
<td style="text-align:left;">
SAINT-POL-DE-LEON
</td>
</tr>
<tr>
<td style="text-align:left;">
10400
</td>
<td style="text-align:left;">
ChIJq2zqdBRJtRIRHS_Tzykphm8
</td>
<td style="text-align:left;">
Salle des fêtes
</td>
<td style="text-align:left;">
7 Rue René Cassin, 07800 La Voulte-sur-Rhône, France
</td>
<td style="text-align:right;">
44.80316
</td>
<td style="text-align:right;">
4.7848268
</td>
<td style="text-align:left;">
point_of_interest establishment
</td>
<td style="text-align:left;">
LA VOULTE-SUR-RHONE
</td>
</tr>
<tr>
<td style="text-align:left;">
12109
</td>
<td style="text-align:left;">
ChIJsxft68LtwkcRXrexqrrufaQ
</td>
<td style="text-align:left;">
VUC Escalade
</td>
<td style="text-align:left;">
Gymnase des Tertiales, 204 Boulevard des Alliés, 59300 Valenciennes, France
</td>
<td style="text-align:right;">
50.36602
</td>
<td style="text-align:right;">
3.5260856
</td>
<td style="text-align:left;">
point_of_interest establishment
</td>
<td style="text-align:left;">
VALENCIENNES
</td>
</tr>
<tr>
<td style="text-align:left;">
13326
</td>
<td style="text-align:left;">
ChIJ_Uq3Awku_kcR96iFbq9l96I
</td>
<td style="text-align:left;">
Salle de la Combe Salle des Fêtes de Saint-Yriex
</td>
<td style="text-align:left;">
152 Rue Jean et Constant Priolaud, 16710 Saint-Yrieix-sur-Charente, France
</td>
<td style="text-align:right;">
45.67820
</td>
<td style="text-align:right;">
0.1428186
</td>
<td style="text-align:left;">
point_of_interest establishment
</td>
<td style="text-align:left;">
SAINT-YRIEIX-SUR-CHARENTE
</td>
</tr>
<tr>
<td style="text-align:left;">
1901
</td>
<td style="text-align:left;">
ChIJEzch4XgZ90cR4AslvDjnL3w
</td>
<td style="text-align:left;">
CUC escalade
</td>
<td style="text-align:left;">
Gymnase Robert Pras, 3 Rue Jean Monnet, 63100 Clermont-Ferrand, France
</td>
<td style="text-align:right;">
45.79300
</td>
<td style="text-align:right;">
3.0676815
</td>
<td style="text-align:left;">
point_of_interest establishment
</td>
<td style="text-align:left;">
CEYRAT
</td>
</tr>
</tbody>
</table>
<p>Cependant, Google a une forte tendance à renvoyer des résultats qui dépassent un peu le périmètre (des faux positifs en quelque sorte). D’autant que dans notre cas, il n’y a pas de <a href="https://developers.google.com/places/web-service/supported_types"><strong>type</strong></a> correspondant aux salles d’escalade permettant de restreindre les résultats à cette catégorie.</p>
<p>Résultat, parmi les <em>places</em> obtenues, on retrouve bien nos salles d’escalade de blocs (Arkose, Block’Out,…) mais aussi des sites naturels de grimpe, des associations, des salles de gym, des restaurants, des campings, etc. Bref, il va falloir faire le ménage!</p>
<p>On commence par filtrer sur les <em>types</em></p>
<pre class="r"><code>library(stringr)
library(tibble)
# on tockenize les types dans un df
lst_type &lt;- tibble(type = unlist(str_split(paste(result_dedup$types,collapse=&quot; &quot;),&quot; &quot;))) %&gt;% 
            group_by(type) %&gt;%
            summarise(n = n())
lst_type  
   # A tibble: 28 x 2
      type               n
      &lt;chr&gt;          &lt;int&gt;
    1 amusement_park     4
    2 bar               22
    3 bicycle_store      1
    4 bowling_alley      1
    5 campground        12
    6 casino             1
    7 church             1
    8 city_hall          2
    9 clothing_store     2
   10 doctor             1
   # ... with 18 more rows</code></pre>
<p>On construit (à la main) la liste de tous les types qui clairement n’ont rien à voir de près ou de loin avec une salle d’escalade et on supprime de la liste des <em>places</em> tout celles qui contiennent au moins un de ces types.</p>
<pre class="r"><code>result_dedup_type_ok &lt;- result_dedup[!str_detect(result_dedup$types, &quot;zoo|university|travel_agency|transit_station|train_station|supermarket|stadium|shoe_store|school|rv_park|real_estate_agency|premise|political|place_of_worship|physiotherapist|parking|park|night_club|natural_feature|museum|movie_theater|meal_takeaway|meal_delivery|lodging|locality|local_government_office|insurance_agency|hospital|home_goods_store|hair_care|grocery_or_supermarket|general_contractor|gas_station|furniture_store|funeral_home|florist|finance|electronics_store|doctor|clothing_store|city_hall|church|cemetery|casino|car_repair|car_rental|car_dealer|campground|bowling_alley|bicycle_store|beauty_salon|bank|bakery|art_gallery|amusement_park|airport|accounting&quot;),]</code></pre>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Il y a peu de POI et la plupart des enseignes ont bien renseigné l’information sur Google.<a href="#fnref1">↩</a></p></li>
</ol>
</div>
