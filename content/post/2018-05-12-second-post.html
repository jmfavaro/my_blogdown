---
title: "Diffusion spatio-temporelle des salles d'escalade de bloc en France"
description: ""
author: "JMF"
date: 2018-05-12T15:29:28+02:00
tags: ["R"]
coversize: full
output: 
  blogdown::html_page:
    toc: true
---


<div id="TOC">
<ul>
<li><a href="#constitution-de-la-base-de-donnees-des-salles-de-blocs-en-france">Constitution de la base de données des salles de blocs en France</a><ul>
<li><a href="#extraction-des-donnees-brutes-google-places">Extraction des données brutes (Google Places)</a></li>
</ul></li>
</ul>
</div>

<p>Pour mon premier post, j’ai choisi un thème qui me tient à coeur : <strong>l’escalade</strong>. Je pratique ce sport depuis 15 ans environ, et, depuis quelques années, une chose m’a frappé : on trouve de plus en plus de salles d’escalade de blocs, et cela partout en France. Pour le géographe que je suis, cela ne fait pas de toute, nous assistons là à une ce que l’on nomme une <strong>diffusion spatiale d’innovation</strong> dans un système urbain.</p>
<p>Pendant très longtemps, sur Paris, la seule salle d’escalade de blocs, c’était <a href="http://www.antrebloc.com/">Antrebloc</a> à Villejuif. Au nord, on avait <a href="https://www.murmur.fr/">MurMur</a> (mais qui ne faisait pas vraiment de bloc, juste un pan), et c’était tout ou presque en ce qui concerne les salles privées. Ce n’est pas que le bloc était une activité confidentielle, simplement, tout du moins en région parisienne, elle était pratiquée en milieu naturel (Fontainebleau).</p>
<div id="constitution-de-la-base-de-donnees-des-salles-de-blocs-en-france" class="section level1">
<h1>Constitution de la base de données des salles de blocs en France</h1>
<p>L’objectif est de consituer une base avec, pour chaque salle :</p>
<ul>
<li>le nom</li>
<li>l’adresse</li>
<li>la longitude/latitude</li>
<li>la date d’ouverture</li>
</ul>
<div id="extraction-des-donnees-brutes-google-places" class="section level2">
<h2>Extraction des données brutes (Google Places)</h2>
<p>Plusieurs méthodes sont possibles : scrapping des storelocators (<em>via</em> la package <code>rvest</code> par exemple) des enseignes, de sites spécialisés comme , mais le plus rapide et certainement le plus efficace est de faire appel à Google Places<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> que l’on va interroger <em>via</em> le package <a href="https://cran.r-project.org/web/packages/googleway/index.html"><code>googleway</code></a>.</p>
<pre class="r"><code>library(RPostgreSQL)
library(googleway)

# liste des communes de plus de 5000 hab
con &lt;- dbConnect(PostgreSQL(), user= &quot;postgres&quot;, password=&quot;postgres&quot;, dbname=&quot;am&quot;, host = &quot;localhost&quot;,  port=5432)
lst_ville &lt;- dbGetQuery(con,&quot;select insee_com, nom_com from geo.geofla_commune_2015 where population &gt; 5000;&quot;)

# définition de la df de résultat
result &lt;- data.frame(place_id = NULL, nom = NULL, adresse = NULL,
                     rating = NULL, lat = NULL, lng = NULL, tags = NULL, ville = NULL,
                     stringsAsFactors = F)

# 1 requete google / ville et append des résultats dans la df
for (i in lst_ville$nom_com) {
  tryCatch({
    gp &lt;- google_places(key = APIkey,search_string = paste0(&quot;rock climbing &quot;, i))
    temp &lt;- data.frame(place_id = gp$results$place_id,
                       nom = gp$results$name,
                       adresse = gp$results$formatted_address,
                       lat = gp$results$geometry$location$lat,
                       lng = gp$results$geometry$location$lng,
                       types = sapply(gp$results$types,paste0,collapse = &quot; &quot;),
                       ville = i,
                       stringsAsFactors = F)
    result &lt;- rbind(result, temp)
    }, error = function(e) {print(paste0(i,&quot; KO&quot;))})
}
# deduplication sur le place_id (id unique)
result_dedup &lt;- result[!duplicated(result$place_id),]</code></pre>
<p>Google a une forte tendance à renvoyer des résultats qui dépassent souvent largement le périmètre que l’on cherche (des faux positifs en quelque sorte). D’autant que dans notre cas, il n’y a pas de <a href="https://developers.google.com/places/web-service/supported_types"><strong>type</strong></a> correspondant aux salles d’escalade permettant de restreindre les résultats à cette catégorie.</p>
<p>Résultat, parmi les places obtenues, on trouve bien nos salles d’escalade de blocs (Arkose, Block’Out,…) mais aussi des sites naturels de grimpe, des clubs, des salles de gym, des restaurants, des campings, etc. Bref, il va falloir faire le ménage!</p>
<pre class="r"><code>library(dplyr)
library(kableExtra)

result_dedup %&gt;% 
  sample_n(., size = 10, replace = TRUE) %&gt;%
  kable(caption = &#39;echantillon de 20 places&#39;) %&gt;%
  kable_styling(bootstrap_options = &quot;striped&quot;, font_size = 9)</code></pre>
<table class="table table-striped" style="font-size: 9px; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">
<span id="tab:tableau1">Table 1: </span>echantillon de 20 places
</caption>
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:left;">
place_id
</th>
<th style="text-align:left;">
nom
</th>
<th style="text-align:left;">
adresse
</th>
<th style="text-align:right;">
lat
</th>
<th style="text-align:right;">
lng
</th>
<th style="text-align:left;">
types
</th>
<th style="text-align:left;">
ville
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
1169
</td>
<td style="text-align:left;">
ChIJu2j0DlejikcRQoymKSpXuZM
</td>
<td style="text-align:left;">
Combe Laval
</td>
<td style="text-align:left;">
26190 Saint-Laurent-en-Royans, France
</td>
<td style="text-align:right;">
45.01706
</td>
<td style="text-align:right;">
5.339522
</td>
<td style="text-align:left;">
point_of_interest establishment
</td>
<td style="text-align:left;">
TAIN-L’HERMITAGE
</td>
</tr>
<tr>
<td style="text-align:left;">
3022
</td>
<td style="text-align:left;">
ChIJ39uUWNMWrRIRKFJ-SSmmkqw
</td>
<td style="text-align:left;">
Tourist Office of the Pays de Figeac
</td>
<td style="text-align:left;">
Hôtel de La Monnaie, Place Vival, 46100 Figeac, France
</td>
<td style="text-align:right;">
44.60785
</td>
<td style="text-align:right;">
2.032492
</td>
<td style="text-align:left;">
travel_agency store point_of_interest establishment
</td>
<td style="text-align:left;">
FIGEAC
</td>
</tr>
<tr>
<td style="text-align:left;">
7949
</td>
<td style="text-align:left;">
ChIJl968RBwvw0cRUhpzWzfni1U
</td>
<td style="text-align:left;">
Mairie
</td>
<td style="text-align:left;">
Rue du Christ, 59960 Neuville-en-Ferrain, France
</td>
<td style="text-align:right;">
50.74748
</td>
<td style="text-align:right;">
3.164429
</td>
<td style="text-align:left;">
point_of_interest establishment
</td>
<td style="text-align:left;">
NEUVILLE-EN-FERRAIN
</td>
</tr>
<tr>
<td style="text-align:left;">
5877
</td>
<td style="text-align:left;">
ChIJS5ZCKCo55kcRRM2Y4kC4ZbQ
</td>
<td style="text-align:left;">
Survilliers - Fosses
</td>
<td style="text-align:left;">
95470 Fosses, France
</td>
<td style="text-align:right;">
49.09958
</td>
<td style="text-align:right;">
2.525629
</td>
<td style="text-align:left;">
train_station transit_station point_of_interest establishment
</td>
<td style="text-align:left;">
FOSSES
</td>
</tr>
<tr>
<td style="text-align:left;">
547
</td>
<td style="text-align:left;">
ChIJWx27kxof4UcRquUbvDOQE14
</td>
<td style="text-align:left;">
hippodrome saint aubin lès elbeuf
</td>
<td style="text-align:left;">
72 Avenue Pasteur, 76410 Saint-Aubin-lès-Elbeuf, France
</td>
<td style="text-align:right;">
49.30840
</td>
<td style="text-align:right;">
1.018935
</td>
<td style="text-align:left;">
gym health point_of_interest establishment
</td>
<td style="text-align:left;">
SAINT-AUBIN-LES-ELBEUF
</td>
</tr>
<tr>
<td style="text-align:left;">
191
</td>
<td style="text-align:left;">
ChIJ5YYaNyeXVA0RAyAuL04oNnU
</td>
<td style="text-align:left;">
Le Teich Escalade
</td>
<td style="text-align:left;">
Place Pierre Dubernet, 33470 Le Teich, France
</td>
<td style="text-align:right;">
44.63453
</td>
<td style="text-align:right;">
-1.021714
</td>
<td style="text-align:left;">
point_of_interest establishment
</td>
<td style="text-align:left;">
ARCACHON
</td>
</tr>
<tr>
<td style="text-align:left;">
8013
</td>
<td style="text-align:left;">
ChIJE4j_BWeUVA0RnR4L1lpYKFI
</td>
<td style="text-align:left;">
L’Orange Bleue
</td>
<td style="text-align:left;">
64 Impasse Nicolas Appert, 33380 Biganos, France
</td>
<td style="text-align:right;">
44.63745
</td>
<td style="text-align:right;">
-0.952713
</td>
<td style="text-align:left;">
gym health point_of_interest establishment
</td>
<td style="text-align:left;">
BIGANOS
</td>
</tr>
<tr>
<td style="text-align:left;">
197
</td>
<td style="text-align:left;">
ChIJMazU3g_15kcRVZd-xmJB6No
</td>
<td style="text-align:left;">
GRIMPO
</td>
<td style="text-align:left;">
40 Rue des Patis, 95300 Pontoise, France
</td>
<td style="text-align:right;">
49.05309
</td>
<td style="text-align:right;">
2.080420
</td>
<td style="text-align:left;">
point_of_interest establishment
</td>
<td style="text-align:left;">
CARRIERES-SOUS-POISSY
</td>
</tr>
<tr>
<td style="text-align:left;">
2207
</td>
<td style="text-align:left;">
ChIJkQOG9Sdv5kcRTcbedxS19O0
</td>
<td style="text-align:left;">
Fitness Park
</td>
<td style="text-align:left;">
Centre commercial Qwartz, 4 Boulevard Gallieni, 92390 Villeneuve-la-Garenne, France
</td>
<td style="text-align:right;">
48.92542
</td>
<td style="text-align:right;">
2.327303
</td>
<td style="text-align:left;">
gym health point_of_interest establishment
</td>
<td style="text-align:left;">
VILLENEUVE-LA-GARENNE
</td>
</tr>
<tr>
<td style="text-align:left;">
5131
</td>
<td style="text-align:left;">
ChIJn6IP1AxWkkcRL15cACKQXEU
</td>
<td style="text-align:left;">
Mayor of Luxeuil-les-Bains
</td>
<td style="text-align:left;">
1 Place Saint-Pierre, 70300 Luxeuil-les-Bains, France
</td>
<td style="text-align:right;">
47.81679
</td>
<td style="text-align:right;">
6.380608
</td>
<td style="text-align:left;">
city_hall local_government_office point_of_interest establishment
</td>
<td style="text-align:left;">
LUXEUIL-LES-BAINS
</td>
</tr>
</tbody>
</table>
<p>On commence par filtrer sur les types</p>
<pre class="r"><code>library(stringr)
# on tockenize les types dans un df
lst_type &lt;- tibble(type = unlist(str_split(paste(result_dedup$types,collapse=&quot; &quot;),&quot; &quot;))) %&gt;% 
            group_by(type) %&gt;%
            summarise(n = n())
lst_type  
   # A tibble: 67 x 2
      type               n
      &lt;chr&gt;          &lt;int&gt;
    1 accounting         1
    2 airport            1
    3 amusement_park    17
    4 art_gallery        2
    5 bakery             1
    6 bank               2
    7 bar               45
    8 beauty_salon       6
    9 bicycle_store      1
   10 bowling_alley      3
   # ... with 57 more rows</code></pre>
<p>On construit (à la main) la liste de tous les types qui clairement n’ont rien à voir de près ou de loin avec une salle d’escalade et on supprime de la liste des <em>places</em> tout celles qui contiennent au moins un de ces types.</p>
<pre class="r"><code>
result_dedup_type_ok &lt;- result_dedup[!str_detect(result_dedup$types, &quot;zoo|university|travel_agency|transit_station|train_station|supermarket|stadium|shoe_store|school|rv_park|real_estate_agency|premise|political|place_of_worship|physiotherapist|parking|park|night_club|natural_feature|museum|movie_theater|meal_takeaway|meal_delivery|lodging|locality|local_government_office|insurance_agency|hospital|home_goods_store|hair_care|grocery_or_supermarket|general_contractor|gas_station|furniture_store|funeral_home|florist|finance|electronics_store|doctor|clothing_store|city_hall|church|cemetery|casino|car_repair|car_rental|car_dealer|campground|bowling_alley|bicycle_store|beauty_salon|bank|bakery|art_gallery|amusement_park|airport|accounting&quot;),]</code></pre>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Il y a peu de POI et la plupart des enseignes ont bien renseigné l’information sur Google.<a href="#fnref1">↩</a></p></li>
</ol>
</div>
